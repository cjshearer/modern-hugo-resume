<!doctype html>
<html>
  <head>
    {{ with (.Page.Title | default $.Site.Title) }}
      <title>{{ . }}</title>
      <meta property="og:title" content="{{ . }}" />
    {{ end }}
    {{ with .Page.Description }}
      <meta property="og:description" content="{{ . }}" />
      <meta name="description" content="{{ . }}" />
    {{ end }}
    <base href="{{ .Site.BaseURL }}" />
    <link rel="canonical" href="{{ .Permalink }}" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="{{ .Permalink }}" />
    {{- with .Page.Params.faviconText -}}
      {{ $faviconString := print
        `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">`
        `<text y="0.9em" font-size="80">` . `</text>
        </svg>`
      }}
      {{ $favicon := $faviconString
        | resources.FromString (print "images/" (md5 $faviconString) ".svg")
        | resources.Minify
      }}
      <link
        rel="icon"
        href="data:{{ $favicon.MediaType.Type }};base64,{{ $favicon.Content | base64Encode }}"
        type="{{ $favicon.MediaType.Type }}"
      />
    {{- else -}}
      {{/* disable favicon request */}}
      <link rel="icon" href="data:image/svg;," />
    {{- end -}}

    {{- with (templates.Defer (dict "key" "global")) -}}
      {{- with resources.Get "css/modern-hugo-resume.css" -}}
        {{ 
          $opts := dict
          "inlineImports" true
          "optimize" hugo.IsProduction
        }}
        {{- $style := . | css.TailwindCSS $opts -}}
        {{- if hugo.IsProduction -}}
          {{- $style = $style | minify | fingerprint -}}
        {{- end -}}
        <style>{{- $style.Content | safeCSS }}</style>
      {{- end -}}
    {{- end -}}
  </head>
  {{ .Content }}
  <script defer>
    (() => {
      const main = document.getElementsByTagName("main")?.[0];
      const footer = document.getElementsByTagName("footer")?.[0];
    
      if (!(footer && main)) return;
    
      // referencePage helps calculate which page to place the footer on when printing
      const referencePage = document.createElement("div");
      referencePage.style.height = "var(--page-height)";
      // css padding emulates PDF margins
      referencePage.style.padding = "var(--page-margin)";
      referencePage.style.position = "absolute";
      referencePage.style.top = "-9999px";
    
      document.body.appendChild(referencePage);
      const referencePageStyles = window.getComputedStyle(referencePage);
      const effectivePageHeight =
        Number.parseFloat(referencePageStyles.height) -
        Number.parseFloat(referencePageStyles.paddingTop) -
        Number.parseFloat(referencePageStyles.paddingBottom);
      document.body.removeChild(referencePage);
    
      // dummyFooter prevents the real footer from overlapping the main document
      const dummyFooter = document.createElement("div");
    
      onbeforeprint = () => {
        // temporarily enable "@media print" to reliably get the height of the elements
        for (style of document.getElementsByTagName("style")) {
          style.innerText = 
            style.innerText.replace(/@media print {/gi, "@media screen { /*print*/");
        }
    
        // temporarily fix width and padding to reliably get the height of elements
        document.body.style.width = "var(--page-width)";
        document.body.style.padding = "var(--page-margin)";
    
        dummyFooter.style.height = getComputedStyle(footer).height;
        const printedDocumentHeight = document.body.scrollHeight;
    
        // reset document styling
        document.body.style.width = "";
        document.body.style.padding = "";
        for (style of document.getElementsByTagName("style")) {
          style.innerText = style.innerText.replace(
            /@media screen { \/\*print\*\//gi,
            "@media print {",
          );
        }
    
        document.documentElement.style.setProperty(
          "--page-count",
          Math.ceil(printedDocumentHeight / effectivePageHeight),
        );
    
        main.appendChild(dummyFooter);
      };
      onafterprint = () => main.removeChild(dummyFooter);
    })();
  </script>
</html>
